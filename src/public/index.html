<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloudflare 域名管理</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        /* Simple transition for showing/hiding elements */
        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.3s ease;
        }
        .fade-enter-from, .fade-leave-to {
            opacity: 0;
        }
        /* Style for active filter button */
        .filter-btn.active {
            background-color: #3b82f6; /* bg-blue-500 */
            color: white;
        }
        /* Ensure modals are visually above others */
        #dns-modal, #record-form-modal, #domain-form-modal, #confirm-modal {
            z-index: 50;
        }
        #notification {
            z-index: 60;
        }
        /* Loading overlay */
        .loading-overlay {
            position: absolute;
            inset: 0;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 40; /* Below modals */
        }
        /* Disable buttons during loading */
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans">
    <div class="container mx-auto px-4 py-8 relative">
        <!-- Loading Overlay -->
        <div id="loading-indicator" class="loading-overlay hidden">
            <i class="fas fa-spinner fa-spin text-blue-500 text-4xl"></i>
        </div>

        <!-- 顶部导航栏 -->
        <nav class="bg-white shadow-lg rounded-lg mb-8 p-4 flex justify-between items-center">
            <div class="flex items-center">
                <i class="fa-solid fa-cloud text-orange-500 text-3xl mr-3"></i>
                <h1 class="text-2xl font-bold text-gray-800">Cloudflare 域名管理</h1>
            </div>
            <div id="user-info" class="hidden flex items-center">
                <span id="user-email-display" class="text-gray-600 mr-4">欢迎回来</span>
                <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded transition duration-150 ease-in-out">
                    <i class="fa-solid fa-right-from-bracket mr-2"></i>退出
                </button>
            </div>
        </nav>

        <!-- API 配置面板 -->
        <div id="api-setup" class="bg-white shadow-lg rounded-lg p-6 mb-8 transition-opacity duration-300 ease-in-out">
            <h2 class="text-xl font-bold mb-4 text-gray-800 flex items-center">
                <i class="fa-solid fa-key text-purple-500 mr-2"></i>API 配置
            </h2>
             <p class="text-sm text-yellow-700 bg-yellow-100 p-3 rounded mb-4 border border-yellow-300"><i class="fas fa-exclamation-triangle mr-2"></i>**安全警告:** 请使用具有严格限制权限的 API Token。直接在浏览器中存储 Global API Key 存在安全风险。</p>
            <div class="mb-4">
                <label class="block text-gray-700 mb-2 font-medium" for="api-key">API Key 或 API Token</label>
                <div class="flex">
                    <input type="password" id="api-key" class="flex-grow border rounded-l py-2 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="输入您的 Cloudflare API Key / Token">
                    <button id="toggle-password" type="button" class="bg-gray-200 px-3 border-t border-r border-b border-gray-300 rounded-r hover:bg-gray-300 transition duration-150 ease-in-out" title="显示/隐藏">
                        <i id="toggle-password-icon" class="fa-solid fa-eye text-gray-600"></i>
                    </button>
                </div>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 mb-2 font-medium" for="email">Email (若使用 API Key)</label>
                <input type="email" id="email" class="w-full border rounded py-2 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="若使用 Global API Key，请输入关联的 Email">
                 <p class="text-xs text-gray-500 mt-1">如果使用 API Token，此项可留空。</p>
            </div>
            <button id="save-api" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded flex items-center transition duration-150 ease-in-out">
                <i class="fa-solid fa-save mr-2"></i>验证并保存
            </button>
        </div>

        <!-- 域名管理部分 -->
        <div id="domain-management" class="hidden transition-opacity duration-300 ease-in-out">
            <!-- Search, Add, Filter -->
            <div class="bg-white shadow-lg rounded-lg p-6 mb-6">
                 <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800 mb-3 sm:mb-0 flex items-center">
                        <i class="fa-solid fa-globe text-blue-500 mr-2"></i>域名管理
                    </h2>
                    <div class="flex flex-wrap gap-2 justify-center sm:justify-end">
                        <div class="relative">
                            <input type="text" id="search-domain" class="border rounded pl-10 pr-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="搜索域名...">
                            <i class="fa-solid fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        </div>
                        <button id="add-domain" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded flex items-center transition duration-150 ease-in-out">
                            <i class="fa-solid fa-plus mr-2"></i>添加域名
                        </button>
                        <button id="refresh-list" class="bg-cyan-500 hover:bg-cyan-600 text-white px-4 py-2 rounded transition duration-150 ease-in-out" title="刷新列表">
                            <i class="fa-solid fa-sync"></i>
                        </button>
                    </div>
                </div>
                 <!-- Filter Options -->
                 <div class="flex flex-wrap gap-2 mb-3 items-center">
                    <span class="text-gray-600 py-1 mr-2 font-medium">过滤状态:</span>
                    <button class="filter-btn active bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded text-sm transition duration-150 ease-in-out" data-filter="all">全部</button>
                    <button class="filter-btn bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded text-sm transition duration-150 ease-in-out" data-filter="active">已激活</button>
                    <button class="filter-btn bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded text-sm transition duration-150 ease-in-out" data-filter="pending">待处理</button>
                     <button class="filter-btn bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded text-sm transition duration-150 ease-in-out" data-filter="initializing">初始化中</button>
                     <button class="filter-btn bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded text-sm transition duration-150 ease-in-out" data-filter="moved">已移动</button>
                     <button class="filter-btn bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded text-sm transition duration-150 ease-in-out" data-filter="deleted">已删除</button>
                     <button class="filter-btn bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded text-sm transition duration-150 ease-in-out" data-filter="deactivated">已停用</button>
                 </div>
            </div>

            <!-- Domain List Table -->
            <div class="bg-white shadow-lg rounded-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">域名</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">状态</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">计划</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">名称服务器</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody id="domain-list" class="bg-white divide-y divide-gray-200">
                            <!-- Rows will be populated by JavaScript -->
                             <tr id="domain-loading-row" class="hidden">
                                <td colspan="5" class="px-6 py-4 text-center text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>加载域名中...</td>
                            </tr>
                             <tr id="domain-no-results-row" class="hidden">
                                <td colspan="5" class="px-6 py-4 text-center text-gray-500">未找到域名或凭据无效。</td>
                            </tr>
                             <tr id="domain-error-row" class="hidden">
                                 <td colspan="5" class="px-6 py-4 text-center text-red-600"><i class="fas fa-exclamation-circle mr-2"></i>加载域名时出错。请检查控制台。</td>
                             </tr>
                        </tbody>
                    </table>
                </div>
                 <!-- Pagination Placeholder -->
                 <div id="domain-pagination" class="bg-white px-4 py-3 border-t border-gray-200 sm:px-6">
                     <!-- Pagination controls will be added here if needed -->
                 </div>
            </div>
        </div>

        <!-- DNS 记录管理模态框 -->
        <div id="dns-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 fade-enter-active fade-leave-active">
             <div class="bg-white rounded-lg shadow-xl max-w-6xl w-full max-h-[90vh] flex flex-col">
                <div class="p-6 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-bold text-gray-900 flex items-center">
                            <i class="fa-solid fa-list text-blue-500 mr-2"></i>
                            <span id="dns-modal-domain" class="domain-name">example.com</span> - DNS 记录管理
                        </h3>
                        <button id="close-dns-modal" type="button" class="text-gray-400 hover:text-gray-600 transition duration-150 ease-in-out">
                            <i class="fa-solid fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                <div class="p-6 flex-grow overflow-y-auto relative">
                     <!-- DNS Loading Overlay -->
                    <div id="dns-loading-indicator" class="loading-overlay hidden">
                        <i class="fas fa-spinner fa-spin text-blue-500 text-3xl"></i>
                    </div>
                     <!-- Add Record Button -->
                    <div class="mb-4">
                        <button id="add-record-btn" type="button" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded flex items-center transition duration-150 ease-in-out">
                            <i class="fa-solid fa-plus mr-2"></i>添加记录
                        </button>
                    </div>
                    <!-- DNS Records Table -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">类型</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">名称</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">内容</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">TTL</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">代理</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                                </tr>
                            </thead>
                            <tbody id="dns-records" class="bg-white divide-y divide-gray-200">
                                <!-- Rows populated by JS -->
                                <tr id="dns-no-records" class="hidden">
                                    <td colspan="6" class="text-center p-4 text-gray-500">此域没有 DNS 记录。</td>
                                </tr>
                                 <tr id="dns-error-row" class="hidden">
                                     <td colspan="6" class="px-6 py-4 text-center text-red-600"><i class="fas fa-exclamation-circle mr-2"></i>加载 DNS 记录时出错。</td>
                                 </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                 <div class="p-4 bg-gray-50 border-t border-gray-200 text-right">
                     <button id="close-dns-modal-footer" type="button" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded text-gray-800 transition duration-150 ease-in-out">关闭</button>
                 </div>
            </div>
        </div>

        <!-- 添加/编辑 DNS 记录模态框 -->
        <div id="record-form-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 fade-enter-active fade-leave-active">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
                 <form id="dns-record-form">
                     <input type="hidden" id="record-id" value="">
                     <input type="hidden" id="current-zone-id" value="">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-bold text-gray-900" id="record-form-title">添加 DNS 记录</h3>
                            <button type="button" id="close-record-form" class="text-gray-400 hover:text-gray-600 transition duration-150 ease-in-out">
                                <i class="fa-solid fa-times text-xl"></i>
                            </button>
                        </div>
                    </div>
                    <div class="p-6 space-y-4 max-h-[60vh] overflow-y-auto">
                        <!-- Record Type -->
                        <div>
                            <label class="block text-gray-700 mb-1 font-medium" for="record-type">记录类型</label>
                            <select id="record-type" class="w-full border rounded py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                                <option value="A">A</option>
                                <option value="AAAA">AAAA</option>
                                <option value="CNAME">CNAME</option>
                                <option value="MX">MX</option>
                                <option value="TXT">TXT</option>
                                <option value="NS">NS</option>
                                <option value="SRV">SRV</option>
                                <option value="CAA">CAA</option>
                                <!-- Add other common types if needed -->
                            </select>
                        </div>
                        <!-- Name -->
                        <div>
                            <label class="block text-gray-700 mb-1 font-medium" for="record-name">名称</label>
                            <input type="text" id="record-name" class="w-full border rounded py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="@ 代表根域名" required>
                            <p class="text-xs text-gray-500 mt-1">例如: @, www, mail, * (通配符)</p>
                        </div>
                        <!-- Content (Varies by type) -->
                        <div id="content-field-A">
                            <label class="block text-gray-700 mb-1 font-medium" for="record-content-A">IPv4 地址</label>
                            <input type="text" id="record-content-A" class="w-full border rounded py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 record-content-input" placeholder="192.0.2.1">
                        </div>
                         <div id="content-field-AAAA" class="hidden">
                            <label class="block text-gray-700 mb-1 font-medium" for="record-content-AAAA">IPv6 地址</label>
                            <input type="text" id="record-content-AAAA" class="w-full border rounded py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 record-content-input" placeholder="2001:db8::1">
                        </div>
                        <div id="content-field-CNAME" class="hidden">
                            <label class="block text-gray-700 mb-1 font-medium" for="record-content-CNAME">目标</label>
                            <input type="text" id="record-content-CNAME" class="w-full border rounded py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 record-content-input" placeholder="target.example.com">
                         </div>
                         <div id="content-field-MX" class="hidden">
                             <label class="block text-gray-700 mb-1 font-medium" for="record-content-MX">邮件服务器</label>
                             <input type="text" id="record-content-MX" class="w-full border rounded py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 record-content-input" placeholder="mail.example.com">
                             <label class="block text-gray-700 mt-2 mb-1 font-medium" for="record-priority">优先级</label>
                             <input type="number" id="record-priority" class="w-full border rounded py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="10" min="0" step="1">
                         </div>
                         <div id="content-field-TXT" class="hidden">
                             <label class="block text-gray-700 mb-1 font-medium" for="record-content-TXT">内容</label>
                             <textarea id="record-content-TXT" rows="3" class="w-full border rounded py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 record-content-input" placeholder="例如: v=spf1 include:_spf.google.com ~all"></textarea>
                         </div>
                         <!-- Add more content fields for SRV, CAA etc. as needed -->
                         <div id="content-field-generic" class="hidden">
                             <label class="block text-gray-700 mb-1 font-medium" for="record-content-generic">内容</label>
                             <input type="text" id="record-content-generic" class="w-full border rounded py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 record-content-input" placeholder="记录内容">
                         </div>
                        <!-- TTL -->
                        <div>
                            <label class="block text-gray-700 mb-1 font-medium" for="record-ttl">TTL</label>
                            <select id="record-ttl" class="w-full border rounded py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="1">自动 (推荐)</option>
                                <option value="60">1 分钟</option>
                                <option value="120">2 分钟</option>
                                <option value="300">5 分钟</option>
                                <option value="600">10 分钟</option>
                                <option value="900">15 分钟</option>
                                <option value="1800">30 分钟</option>
                                <option value="3600">1 小时</option>
                                <option value="7200">2 小时</option>
                                <option value="18000">5 小时</option>
                                <option value="43200">12 小时</option>
                                <option value="86400">1 天</option>
                            </select>
                        </div>
                        <!-- Proxy Status -->
                        <div class="flex items-center" id="proxy-toggle-container">
                            <label class="inline-flex items-center mr-4 cursor-pointer">
                                <input type="checkbox" id="proxy-status" class="form-checkbox h-5 w-5 rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-offset-0 focus:ring-blue-200 focus:ring-opacity-50">
                                <span class="ml-2 text-gray-700">代理状态 (橙色云)</span>
                            </label>
                            <i class="fa-solid fa-info-circle text-gray-400" title="Cloudflare 加速和保护。仅适用于 A, AAAA, CNAME。"></i>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-50 border-t border-gray-200 flex justify-end space-x-2">
                        <button type="button" id="cancel-record" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded text-gray-800 transition duration-150 ease-in-out">取消</button>
                        <button type="submit" id="save-record-btn" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 rounded text-white transition duration-150 ease-in-out">保存记录</button>
                    </div>
                 </form>
            </div>
        </div>

        <!-- 添加域名模态框 -->
        <div id="domain-form-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 fade-enter-active fade-leave-active">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
                <form id="domain-form">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-bold text-gray-900">添加新域名</h3>
                            <button type="button" id="close-domain-form" class="text-gray-400 hover:text-gray-600 transition duration-150 ease-in-out">
                                <i class="fa-solid fa-times text-xl"></i>
                            </button>
                        </div>
                    </div>
                    <div class="p-6 space-y-4">
                        <div>
                            <label class="block text-gray-700 mb-1 font-medium" for="domain-name">域名</label>
                            <input type="text" id="domain-name" class="w-full border rounded py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="example.com" required>
                            <p class="text-xs text-gray-500 mt-1">请输入不带 http:// 或 https:// 的域名。</p>
                        </div>
                         <!-- Account Selection (Optional but needed for robustness) -->
                         <!--
                         <div class="mb-4">
                            <label class="block text-gray-700 mb-1 font-medium" for="account-id-select">账户</label>
                            <select id="account-id-select" class="w-full border rounded py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                                <option value="" disabled selected>选择账户...</option>
                                Populated by JS if multiple accounts found
                            </select>
                         </div>
                         -->
                         <p class="text-sm text-gray-600">域名将添加到与您的 API 凭证关联的账户中。</p>
                    </div>
                    <div class="p-4 bg-gray-50 border-t border-gray-200 flex justify-end space-x-2">
                        <button type="button" id="cancel-domain" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded text-gray-800 transition duration-150 ease-in-out">取消</button>
                        <button type="submit" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 rounded text-white transition duration-150 ease-in-out">添加域名</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 警告确认模态框 -->
        <div id="confirm-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 fade-enter-active fade-leave-active">
           <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
                <div class="p-6">
                    <div class="flex flex-col items-center text-center">
                         <div class="text-red-500 mb-4">
                            <i id="confirm-icon" class="fa-solid fa-exclamation-triangle text-5xl"></i>
                        </div>
                        <h3 class="text-lg font-bold text-gray-900 mb-2" id="confirm-title">确认操作</h3>
                        <p class="text-gray-600 mb-6" id="confirm-message">您确定要执行此操作吗？</p>
                     </div>
                    <div class="flex justify-center space-x-4">
                        <button id="cancel-confirm" type="button" class="px-6 py-2 bg-gray-200 hover:bg-gray-300 rounded text-gray-800 transition duration-150 ease-in-out">取消</button>
                        <button id="proceed-confirm" type="button" class="px-6 py-2 bg-red-500 hover:bg-red-600 rounded text-white transition duration-150 ease-in-out">确认</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 通知提示组件 -->
         <div id="notification" class="hidden fixed top-5 right-5 max-w-sm w-full bg-white shadow-lg rounded-lg pointer-events-auto ring-1 ring-black ring-opacity-5 overflow-hidden border-l-4 z-60">
             <div class="p-4">
                <div class="flex items-start">
                    <div id="notification-icon" class="flex-shrink-0 pt-0.5">
                        <!-- Icon set dynamically -->
                    </div>
                    <div class="ml-3 w-0 flex-1">
                        <p id="notification-title" class="text-sm font-medium text-gray-900">通知</p>
                        <p id="notification-message" class="mt-1 text-sm text-gray-500">消息内容</p>
                    </div>
                    <div class="ml-4 flex-shrink-0 flex">
                        <button id="close-notification" type="button" class="bg-white rounded-md inline-flex text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <span class="sr-only">Close</span>
                            <i class="fa-solid fa-times h-5 w-5"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Constants ---
            const CLOUDFLARE_API_BASE = 'https://api.cloudflare.com/client/v4';

            // --- DOM Elements ---
            const loadingIndicator = document.getElementById('loading-indicator');
            const apiKeyInput = document.getElementById('api-key');
            const emailInput = document.getElementById('email');
            const saveApiButton = document.getElementById('save-api');
            const togglePasswordButton = document.getElementById('toggle-password');
            const togglePasswordIcon = document.getElementById('toggle-password-icon');
            const apiSetupDiv = document.getElementById('api-setup');
            const domainManagementDiv = document.getElementById('domain-management');
            const userInfoDiv = document.getElementById('user-info');
            const userEmailDisplay = document.getElementById('user-email-display');
            const logoutButton = document.getElementById('logout-btn');

            // Domain List Elements
            const domainListBody = document.getElementById('domain-list');
            const domainLoadingRow = document.getElementById('domain-loading-row');
            const domainNoResultsRow = document.getElementById('domain-no-results-row');
            const domainErrorRow = document.getElementById('domain-error-row');
            const searchDomainInput = document.getElementById('search-domain');
            const filterButtons = document.querySelectorAll('.filter-btn');
            const refreshListButton = document.getElementById('refresh-list');

            // Add Domain Modal Elements
            const addDomainButton = document.getElementById('add-domain');
            const domainFormModal = document.getElementById('domain-form-modal');
            const closeDomainFormButton = document.getElementById('close-domain-form');
            const cancelDomainButton = document.getElementById('cancel-domain');
            const domainForm = document.getElementById('domain-form');
            const domainNameInput = document.getElementById('domain-name');

            // DNS Modal Elements
            const dnsModal = document.getElementById('dns-modal');
            const dnsLoadingIndicator = document.getElementById('dns-loading-indicator');
            const closeDnsModalButton = document.getElementById('close-dns-modal');
            const closeDnsModalFooterButton = document.getElementById('close-dns-modal-footer');
            const dnsModalDomainTitle = document.getElementById('dns-modal-domain');
            const dnsRecordsBody = document.getElementById('dns-records');
            const dnsNoRecordsRow = document.getElementById('dns-no-records');
            const dnsErrorRow = document.getElementById('dns-error-row');

            // Add/Edit Record Modal Elements
            const addRecordButton = document.getElementById('add-record-btn');
            const recordFormModal = document.getElementById('record-form-modal');
            const closeRecordFormButton = document.getElementById('close-record-form');
            const cancelRecordButton = document.getElementById('cancel-record');
            const dnsRecordForm = document.getElementById('dns-record-form');
            const recordFormTitle = document.getElementById('record-form-title');
            const recordIdInput = document.getElementById('record-id');
            const currentZoneIdInput = document.getElementById('current-zone-id'); // To hold zone id for the form
            const recordTypeSelect = document.getElementById('record-type');
            const recordNameInput = document.getElementById('record-name');
            const recordTtlSelect = document.getElementById('record-ttl');
            const proxyStatusCheckbox = document.getElementById('proxy-status');
            const proxyToggleContainer = document.getElementById('proxy-toggle-container');
            const recordContentInputs = document.querySelectorAll('.record-content-input'); // All content inputs
            const mxPriorityInput = document.getElementById('record-priority');

            // Confirmation Modal Elements
            const confirmModal = document.getElementById('confirm-modal');
            const confirmTitle = document.getElementById('confirm-title');
            const confirmMessage = document.getElementById('confirm-message');
            const confirmIcon = document.getElementById('confirm-icon');
            const cancelConfirmButton = document.getElementById('cancel-confirm');
            const proceedConfirmButton = document.getElementById('proceed-confirm');

            // Notification Elements
            const notification = document.getElementById('notification');
            const notificationTitle = document.getElementById('notification-title');
            const notificationMessage = document.getElementById('notification-message');
            const notificationIcon = document.getElementById('notification-icon');
            const closeNotificationButton = document.getElementById('close-notification');

            // --- State Variables ---
            let currentApiAuth = { key: null, email: null };
            let currentAccountId = null; // Store the first found account ID
            let currentConfirmCallback = null;
            let notificationTimeout = null;
            let activeDomainFilter = 'all'; // Store current domain filter
            let domainListData = []; // Store fetched domain data for client-side filtering


            // --- Utility Functions ---
            const showLoading = (global = true) => {
                loadingIndicator.classList.remove('hidden');
                if (global) {
                    // Disable major action buttons
                    saveApiButton.disabled = true;
                    addDomainButton.disabled = true;
                    refreshListButton.disabled = true;
                }
            };
            const hideLoading = () => {
                 loadingIndicator.classList.add('hidden');
                 // Re-enable buttons
                 saveApiButton.disabled = false;
                 addDomainButton.disabled = false;
                 refreshListButton.disabled = false;
            };
            const showDnsLoading = () => dnsLoadingIndicator.classList.remove('hidden');
            const hideDnsLoading = () => dnsLoadingIndicator.classList.add('hidden');

            const showElement = (el) => el && el.classList.remove('hidden');
            const hideElement = (el) => el && el.classList.add('hidden');

            const showModal = (modalEl) => {
                if (!modalEl) return;
                modalEl.classList.remove('hidden');
                requestAnimationFrame(() => {
                    modalEl.classList.add('fade-enter-active');
                    modalEl.classList.remove('fade-enter-from');
                });
            };

            const hideModal = (modalEl) => {
                if (!modalEl) return;
                modalEl.classList.add('fade-leave-active', 'fade-leave-to');
                modalEl.classList.remove('fade-enter-active');
                setTimeout(() => {
                    modalEl.classList.add('hidden');
                    modalEl.classList.remove('fade-leave-active', 'fade-leave-to');
                    const form = modalEl.querySelector('form');
                    if (form) form.reset();
                    if (modalEl.id === 'record-form-modal') recordIdInput.value = '';
                    if (modalEl.id === 'confirm-modal') currentConfirmCallback = null;
                }, 300);
            };

            function showNotification(title, message, type = 'success', duration = 5000) {
                notificationTitle.textContent = title;
                notificationMessage.textContent = message;
                notification.classList.remove('border-green-500', 'border-red-500', 'border-yellow-500', 'border-blue-500');
                let iconHtml = '';
                let borderColor = '';

                switch (type) {
                    case 'error':
                        iconHtml = '<i class="fa-solid fa-circle-xmark text-red-500 text-xl"></i>';
                        borderColor = 'border-red-500';
                        break;
                    case 'warning':
                        iconHtml = '<i class="fa-solid fa-triangle-exclamation text-yellow-500 text-xl"></i>';
                        borderColor = 'border-yellow-500';
                        break;
                    case 'info':
                         iconHtml = '<i class="fa-solid fa-circle-info text-blue-500 text-xl"></i>';
                         borderColor = 'border-blue-500';
                         break;
                    case 'success':
                    default:
                        iconHtml = '<i class="fa-solid fa-circle-check text-green-500 text-xl"></i>';
                        borderColor = 'border-green-500';
                        break;
                }
                notificationIcon.innerHTML = iconHtml;
                notification.classList.add(borderColor);
                showElement(notification);
                if (notificationTimeout) clearTimeout(notificationTimeout);
                if(duration > 0) {
                    notificationTimeout = setTimeout(hideNotification, duration);
                }
            }

            function hideNotification() {
                hideElement(notification);
                if (notificationTimeout) clearTimeout(notificationTimeout);
            }

            function showConfirmation(title, message, onConfirm, type = 'warning') {
                 confirmTitle.textContent = title;
                 confirmMessage.textContent = message;
                 currentConfirmCallback = onConfirm;
                 // Set icon based on type (e.g., warning, danger)
                 confirmIcon.className = type === 'danger'
                    ? 'fa-solid fa-trash-alt text-5xl text-red-500'
                    : 'fa-solid fa-exclamation-triangle text-5xl text-yellow-500';
                 // Change button color for danger
                 proceedConfirmButton.className = type === 'danger'
                    ? 'px-6 py-2 bg-red-600 hover:bg-red-700 rounded text-white transition duration-150 ease-in-out'
                    : 'px-6 py-2 bg-yellow-500 hover:bg-yellow-600 rounded text-white transition duration-150 ease-in-out';

                 showModal(confirmModal);
            }

            // --- Cloudflare API Request Function ---
            async function cloudflareApiRequest(endpoint, method = 'GET', body = null) {
                const { key, email } = currentApiAuth; // Get current credentials
                if (!key) {
                    throw new Error("API Key/Token not set.");
                }

                const headers = {
                    'Accept': 'application/json',
                };
                // Use Bearer token auth if email is not provided (assume API Token)
                 if (email) {
                     headers['X-Auth-Email'] = email;
                     headers['X-Auth-Key'] = key;
                 } else {
                     headers['Authorization'] = `Bearer ${key}`;
                 }

                const options = {
                    method,
                    headers,
                };

                if (body && (method === 'POST' || method === 'PUT' || method === 'PATCH')) {
                    headers['Content-Type'] = 'application/json';
                    options.body = JSON.stringify(body);
                }

                const url = `${CLOUDFLARE_API_BASE}${endpoint}`;

                try {
                    const response = await fetch(url, options);

                    // Handle rate limits specifically if possible (429)
                    if (response.status === 429) {
                         throw new Error("Rate limit exceeded. Please wait and try again.");
                    }

                    const data = await response.json();

                    if (!data.success) {
                        // Consolidate multiple errors into one message
                        const errorMessages = data.errors.map(e => `(${e.code}) ${e.message}`).join('; ');
                         console.error('Cloudflare API Error:', data.errors);
                        throw new Error(`API Error: ${errorMessages}`);
                    }

                    return data; // Return the full response object (includes result, result_info, etc.)

                } catch (error) {
                     console.error(`Error making Cloudflare API request to ${method} ${endpoint}:`, error);
                     // Re-throw a user-friendly or the original error
                     throw error instanceof Error ? error : new Error("Network error or failed to parse response.");
                 }
            }


            // --- Authentication & Initialization ---
            function loadAndValidateCredentials() {
                const savedKey = sessionStorage.getItem('cfApiKey');
                const savedEmail = sessionStorage.getItem('cfEmail'); // Might be null for tokens

                if (savedKey) {
                    currentApiAuth = { key: savedKey, email: savedEmail };
                    // Attempt to validate by fetching zones
                    validateCredentialsAndLoadDomains(false); // false = don't show success message on load
                 } else {
                    // No saved credentials, show setup
                    showElement(apiSetupDiv);
                    hideElement(domainManagementDiv);
                    hideElement(userInfoDiv);
                }
            }

             async function validateCredentialsAndLoadDomains(showSuccessNotification = true) {
                showLoading();
                hideElement(domainErrorRow); // Hide previous errors
                hideElement(domainNoResultsRow);
                showElement(domainLoadingRow);
                domainListBody.innerHTML = ''; // Clear previous list items

                try {
                    // Use list zones with minimal data as a validation check
                    // Also try to get the account ID from the first zone found
                    const response = await cloudflareApiRequest('/zones?per_page=1&status=active'); // Fetch just one active zone

                    if (response.result && response.result.length > 0) {
                         currentAccountId = response.result[0].account.id; // Store account ID
                    } else {
                         // Maybe no active zones, try fetching user info if email exists to get account ID?
                         // For simplicity now, we'll proceed without account ID if no zones found initially.
                         // Adding a domain might fail later if account ID is truly required and not found.
                         console.warn("Could not automatically determine Account ID. Adding domains might fail.");
                         // Could try /user endpoint if using key/email, but not for tokens.
                         // const userResponse = await cloudflareApiRequest('/user'); // Example if needed
                         // currentAccountId = userResponse.result?.account?.id;
                     }


                     if (showSuccessNotification) {
                         showNotification('验证成功', 'API 凭证有效。正在加载域名...', 'success');
                     }
                     userEmailDisplay.textContent = currentApiAuth.email ? `账户: ${currentApiAuth.email}` : '已验证 Token';
                     hideElement(apiSetupDiv);
                     showElement(domainManagementDiv);
                     showElement(userInfoDiv);

                     // Now fetch the full list of domains
                     await fetchAndRenderDomains();

                 } catch (error) {
                     console.error("Credential validation failed:", error);
                     showNotification('验证失败', `无法验证凭证或获取账户信息: ${error.message}`, 'error');
                     // Clear potentially invalid stored credentials
                     clearCredentials();
                     showElement(apiSetupDiv);
                     hideElement(domainManagementDiv);
                     hideElement(userInfoDiv);
                     hideElement(domainLoadingRow);
                     showElement(domainNoResultsRow); // Show no results as validation failed
                 } finally {
                    hideLoading();
                }
            }

            saveApiButton.addEventListener('click', () => {
                const key = apiKeyInput.value.trim();
                 // Email is optional if it looks like a token (usually longer, no '@')
                const email = emailInput.value.trim();
                 const isLikelyToken = key.length > 45 && !email; // Heuristic for token

                if (!key) {
                    showNotification('错误', '请输入 API Key 或 API Token。', 'error');
                    return;
                }
                 if (!isLikelyToken && !email) {
                     showNotification('错误', '使用 API Key 时必须提供 Email。', 'error');
                     return;
                 }
                  if (!isLikelyToken && email && !/\S+@\S+\.\S+/.test(email)) {
                      showNotification('错误', '请输入有效的 Email 地址。', 'error');
                      return;
                  }

                 // Store temporarily for validation attempt
                 currentApiAuth = { key, email: isLikelyToken ? null : email }; // Store null email for tokens

                 // Validate and proceed
                 validateCredentialsAndLoadDomains(true).then(() => {
                    // Only save to sessionStorage AFTER successful validation
                    sessionStorage.setItem('cfApiKey', currentApiAuth.key);
                    if (currentApiAuth.email) {
                        sessionStorage.setItem('cfEmail', currentApiAuth.email);
                    } else {
                        sessionStorage.removeItem('cfEmail'); // Ensure email is removed if using token
                    }
                 }).catch(() => {
                     // Error handled within validateCredentialsAndLoadDomains
                     // Clear the temporary auth state if validation failed
                     currentApiAuth = { key: null, email: null };
                     currentAccountId = null;
                 });
            });

            function clearCredentials() {
                 sessionStorage.removeItem('cfApiKey');
                 sessionStorage.removeItem('cfEmail');
                 currentApiAuth = { key: null, email: null };
                 currentAccountId = null;
                 apiKeyInput.value = '';
                 emailInput.value = '';
            }

            logoutButton.addEventListener('click', () => {
                showConfirmation('退出', '您确定要清除保存的凭证并退出吗？', () => {
                    clearCredentials();
                    domainListBody.innerHTML = ''; // Clear domain list UI
                    hideElement(domainManagementDiv);
                    hideElement(userInfoDiv);
                    showElement(apiSetupDiv);
                    hideModal(confirmModal);
                    showNotification('已退出', 'API 凭证已清除。', 'info');
                }, 'warning');
            });

            togglePasswordButton.addEventListener('click', () => {
                const isPassword = apiKeyInput.type === 'password';
                apiKeyInput.type = isPassword ? 'text' : 'password';
                togglePasswordIcon.classList.toggle('fa-eye', !isPassword);
                togglePasswordIcon.classList.toggle('fa-eye-slash', isPassword);
            });


            // --- Domain List Logic ---

            async function fetchAndRenderDomains() {
                 showElement(domainLoadingRow);
                 hideElement(domainNoResultsRow);
                 hideElement(domainErrorRow);
                 // domainListBody.innerHTML = ''; // Clear previous content implicitly by render function

                 try {
                     // Fetch all zones (consider pagination for very large accounts)
                     // const response = await cloudflareApiRequest('/zones?per_page=50'); // Example pagination
                     const response = await cloudflareApiRequest('/zones');
                     domainListData = response.result || []; // Store the raw data
                     renderDomainList(); // Render based on stored data and filters
                 } catch (error) {
                     console.error("Error fetching domains:", error);
                     showNotification('错误', `加载域名列表失败: ${error.message}`, 'error');
                     domainListBody.innerHTML = ''; // Clear
                     showElement(domainErrorRow);
                 } finally {
                    hideElement(domainLoadingRow);
                 }
            }

            function renderDomainList() {
                 domainListBody.innerHTML = ''; // Clear existing rows
                 const searchTerm = searchDomainInput.value.toLowerCase();
                 let hasResults = false;

                 const filteredData = domainListData.filter(zone => {
                     const matchesSearch = !searchTerm || zone.name.toLowerCase().includes(searchTerm);
                     const matchesFilter = activeDomainFilter === 'all' || zone.status === activeDomainFilter;
                     return matchesSearch && matchesFilter;
                 });

                if (filteredData.length === 0) {
                    showElement(domainNoResultsRow);
                    return;
                } else {
                    hideElement(domainNoResultsRow);
                 }

                 filteredData.forEach(zone => {
                     const row = document.createElement('tr');
                     row.className = 'domain-row hover:bg-gray-50';
                     row.dataset.zoneId = zone.id;
                     row.dataset.zoneName = zone.name;
                     row.dataset.zoneStatus = zone.status;

                     // Status Badge Mapping
                     let statusBadgeClass = 'bg-gray-100 text-gray-800';
                     let statusIcon = 'fa-solid fa-question-circle text-gray-500'; // Default
                     switch (zone.status) {
                         case 'active':
                             statusBadgeClass = 'bg-green-100 text-green-800';
                             statusIcon = 'fa-solid fa-check-circle text-green-500';
                             break;
                         case 'pending':
                             statusBadgeClass = 'bg-yellow-100 text-yellow-800';
                              statusIcon = 'fa-solid fa-hourglass-half text-yellow-500';
                             break;
                         case 'initializing':
                             statusBadgeClass = 'bg-blue-100 text-blue-800';
                             statusIcon = 'fa-solid fa-spinner fa-spin text-blue-500';
                             break;
                         case 'moved':
                         case 'deleted':
                         case 'deactivated':
                              statusBadgeClass = 'bg-red-100 text-red-800';
                              statusIcon = 'fa-solid fa-times-circle text-red-500';
                              break;
                     }

                     row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <i class="${statusIcon} mr-2"></i>
                                <span class="font-medium text-gray-900">${zone.name}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusBadgeClass}">
                                ${zone.status}
                            </span>
                        </td>
                         <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${zone.plan?.name || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                            <div class="truncate max-w-xs" title="${(zone.name_servers || []).join(', ')}">
                                ${(zone.name_servers || ['N/A']).join(', ')}
                             </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div class="flex space-x-2">
                                <button class="manage-records-btn text-blue-600 hover:text-blue-900 transition duration-150 ease-in-out" title="管理 DNS 记录">
                                    <i class="fa-solid fa-list"></i>
                                </button>
                                <button class="delete-domain-btn text-red-600 hover:text-red-900 transition duration-150 ease-in-out" title="删除域名">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                                <!-- Add buttons for other actions if needed -->
                            </div>
                        </td>
                    `;
                    domainListBody.appendChild(row);
                    addDomainRowEventListeners(row); // Attach listeners to the new row
                 });
            }

             searchDomainInput.addEventListener('input', renderDomainList); // Filter on input

             filterButtons.forEach(button => {
                 button.addEventListener('click', () => {
                     filterButtons.forEach(btn => btn.classList.replace('bg-blue-500','bg-gray-200') || btn.classList.remove('active', 'text-white')); // Reset styles more carefully
                     button.classList.add('active','bg-blue-500', 'text-white');
                     button.classList.remove('bg-gray-200');
                     activeDomainFilter = button.dataset.filter;
                     renderDomainList(); // Re-render with new filter
                 });
             });

             refreshListButton.addEventListener('click', async () => {
                 showNotification('刷新中', '正在重新加载域名列表...', 'info');
                 await fetchAndRenderDomains(); // Fetch fresh data from API
                 showNotification('完成', '域名列表已刷新。', 'success', 2000);
             });

             // Attach listeners to buttons within a domain row
            function addDomainRowEventListeners(row) {
                const zoneId = row.dataset.zoneId;
                const zoneName = row.dataset.zoneName;

                row.querySelector('.manage-records-btn')?.addEventListener('click', () => {
                    openDnsModal(zoneId, zoneName);
                });

                 row.querySelector('.delete-domain-btn')?.addEventListener('click', () => {
                    showConfirmation(
                        '确认删除域名',
                        `您确定要从 Cloudflare 账户中永久删除域名 "${zoneName}" 及其所有配置吗？此操作无法撤销！`,
                        async () => {
                            showLoading(false); // Show local loading
                            proceedConfirmButton.disabled = true;
                            cancelConfirmButton.disabled = true;
                            try {
                                await cloudflareApiRequest(`/zones/${zoneId}`, 'DELETE');
                                hideModal(confirmModal);
                                showNotification('已删除', `域名 "${zoneName}" 已成功删除。`, 'success');
                                // Remove from local data and re-render
                                domainListData = domainListData.filter(zone => zone.id !== zoneId);
                                renderDomainList();
                            } catch (error) {
                                showNotification('删除失败', `删除域名 "${zoneName}" 时出错: ${error.message}`, 'error', 0); // Keep error showing
                            } finally {
                                hideLoading();
                                proceedConfirmButton.disabled = false;
                                cancelConfirmButton.disabled = false;
                                // Ensure confirm modal is hidden even on error if needed, though usually keep it for context
                                // hideModal(confirmModal);
                             }
                        },
                        'danger' // Use danger styling for deletion
                    );
                });
            }

            // --- Add Domain Modal Logic ---
            addDomainButton.addEventListener('click', () => {
                if (!currentAccountId) {
                    // Attempt to fetch it again if missed initially, or show error
                    showNotification('需要账户 ID', '无法自动确定账户 ID。请确保 API 凭证有效且至少有一个域名。', 'warning');
                    // Optionally, add an Account ID input field here.
                    // return; // Prevent opening modal if account ID is strictly needed
                 }
                domainForm.reset();
                showModal(domainFormModal);
            });

            closeDomainFormButton.addEventListener('click', () => hideModal(domainFormModal));
            cancelDomainButton.addEventListener('click', () => hideModal(domainFormModal));

            domainForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newDomain = domainNameInput.value.trim();
                if (!newDomain) {
                    showNotification('错误', '请输入域名。', 'error');
                    return;
                }
                 if (!currentAccountId) {
                     // Reiterate the Account ID issue if submitting without one
                     showNotification('无法添加', '缺少账户 ID，无法添加域名。请检查初始凭证验证。', 'error');
                     return;
                 }

                const submitButton = domainForm.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>添加中...';

                try {
                    const payload = {
                        name: newDomain,
                        account: { id: currentAccountId },
                        // type: 'full' // Default is 'full', 'partial' for CNAME setup (not implemented in UI)
                    };
                    const response = await cloudflareApiRequest('/zones', 'POST', payload);

                    hideModal(domainFormModal);
                    showNotification('成功', `域名 "${response.result.name}" 已成功添加。`, 'success');
                    // Add the new domain to local data and re-render
                    domainListData.push(response.result);
                    renderDomainList();

                } catch (error) {
                    showNotification('添加失败', `添加域名 "${newDomain}" 时出错: ${error.message}`, 'error', 0); // Keep error showing
                 } finally {
                    submitButton.disabled = false;
                    submitButton.innerHTML = '添加域名';
                }
            });

            // --- DNS Records Modal Logic ---
            async function openDnsModal(zoneId, zoneName) {
                 dnsModalDomainTitle.textContent = zoneName;
                 currentZoneIdInput.value = zoneId; // Store zone ID for the record form
                 dnsRecordsBody.innerHTML = ''; // Clear previous records
                 hideElement(dnsNoRecordsRow);
                 hideElement(dnsErrorRow);
                 showDnsLoading();
                 showModal(dnsModal);

                 try {
                    const response = await cloudflareApiRequest(`/zones/${zoneId}/dns_records`);
                    const records = response.result || [];
                    renderDnsRecords(records, zoneName);
                 } catch (error) {
                    console.error(`Error fetching DNS records for ${zoneName}:`, error);
                    showNotification('错误', `加载 DNS 记录失败: ${error.message}`, 'error');
                     showElement(dnsErrorRow);
                 } finally {
                     hideDnsLoading();
                 }
            }

             function renderDnsRecords(records, zoneName) {
                dnsRecordsBody.innerHTML = ''; // Clear
                if (records.length === 0) {
                    showElement(dnsNoRecordsRow);
                    return;
                }
                 hideElement(dnsNoRecordsRow);

                records.forEach(record => {
                    const row = document.createElement('tr');
                    row.className = 'dns-record-row hover:bg-gray-50';
                    row.dataset.recordId = record.id;
                    row.dataset.zoneId = record.zone_id; // Redundant but maybe useful
                    // Store all record data for editing
                    row.dataset.recordData = JSON.stringify(record);

                    const typeClass = getRecordTypeClass(record.type);
                    const ttlText = record.ttl === 1 ? '自动' : `${record.ttl} 秒`;
                     // Display full name, but store API name (@ for root) in data attribute if needed
                     const displayName = record.name;
                     const apiName = record.name === zoneName ? '@' : record.name.replace(`.${zoneName}`, '');


                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="record-type px-2 py-1 rounded text-xs font-medium ${typeClass}">${record.type}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 record-name" title="${record.name}">${displayName}</td>
                         <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 record-content truncate max-w-xs" title="${record.content}">${record.content} ${record.priority !== undefined ? `(Prio: ${record.priority})` : ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 record-ttl" data-ttl-value="${record.ttl}">${ttlText}</td>
                        <td class="px-6 py-4 whitespace-nowrap record-proxied" data-proxied="${record.proxied}">
                            <span class="flex items-center">
                                <span class="h-3 w-3 ${record.proxied ? 'bg-orange-400' : 'bg-gray-400'} rounded-full mr-2"></span>
                                <span class="text-sm">${record.proxied ? '已代理' : '仅 DNS'}</span>
                             </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div class="flex space-x-3">
                                <button class="edit-record-btn text-blue-600 hover:text-blue-900 transition duration-150 ease-in-out" title="编辑记录">
                                    <i class="fa-solid fa-edit"></i>
                                </button>
                                <button class="delete-record-btn text-red-600 hover:text-red-900 transition duration-150 ease-in-out" title="删除记录">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    dnsRecordsBody.appendChild(row);
                    addDnsRecordEventListeners(row);
                });
            }

            // Add listeners to DNS record row buttons
             function addDnsRecordEventListeners(row) {
                 const recordId = row.dataset.recordId;
                 const zoneId = row.dataset.zoneId; // Get zoneId from row if needed
                 const recordData = JSON.parse(row.dataset.recordData);


                 row.querySelector('.edit-record-btn')?.addEventListener('click', () => {
                     populateRecordForm(recordData);
                 });

                 row.querySelector('.delete-record-btn')?.addEventListener('click', () => {
                     showConfirmation(
                         '确认删除 DNS 记录',
                         `您确定要删除 ${recordData.type} 记录 "${recordData.name}" 吗？此操作无法撤销。`,
                         async () => {
                            showDnsLoading(); // Show loading within the modal
                             proceedConfirmButton.disabled = true;
                             cancelConfirmButton.disabled = true;
                             try {
                                 await cloudflareApiRequest(`/zones/${recordData.zone_id}/dns_records/${recordId}`, 'DELETE');
                                 hideModal(confirmModal);
                                 showNotification('已删除', `DNS 记录 "${recordData.name}" 已删除。`, 'success');
                                 row.remove(); // Remove row from UI
                                 // Check if no records left
                                 if (dnsRecordsBody.querySelectorAll('.dns-record-row').length === 0) {
                                     showElement(dnsNoRecordsRow);
                                 }
                             } catch (error) {
                                 showNotification('删除失败', `删除 DNS 记录时出错: ${error.message}`, 'error', 0);
                             } finally {
                                hideDnsLoading();
                                proceedConfirmButton.disabled = false;
                                cancelConfirmButton.disabled = false;
                                // hideModal(confirmModal); // Decide whether to hide confirm on error
                            }
                         },
                         'danger'
                     );
                 });
             }

            closeDnsModalButton.addEventListener('click', () => hideModal(dnsModal));
            closeDnsModalFooterButton.addEventListener('click', () => hideModal(dnsModal));


            // --- Add/Edit DNS Record Form Logic ---

            addRecordButton.addEventListener('click', () => {
                 const zoneName = dnsModalDomainTitle.textContent;
                 recordFormTitle.textContent = `添加 DNS 记录 (${zoneName})`;
                 dnsRecordForm.reset();
                 recordIdInput.value = ''; // Clear ID for adding
                 currentZoneIdInput.value = document.querySelector(`tr[data-zone-name="${zoneName}"]`)?.dataset?.zoneId || currentZoneIdInput.value; // Ensure zone ID is set
                 updateRecordFormUI('A'); // Reset to default type A UI
                 showModal(recordFormModal);
            });

            closeRecordFormButton.addEventListener('click', () => hideModal(recordFormModal));
            cancelRecordButton.addEventListener('click', () => hideModal(recordFormModal));

            // Populate the form when editing
             function populateRecordForm(record) {
                const zoneName = record.zone_name;
                recordFormTitle.textContent = `编辑 DNS 记录 (${zoneName})`;
                dnsRecordForm.reset(); // Start clean

                recordIdInput.value = record.id;
                currentZoneIdInput.value = record.zone_id;
                recordTypeSelect.value = record.type;
                // Convert full domain name back to '@' or subdomain part
                const apiName = record.name === zoneName ? '@' : record.name.replace(`.${zoneName}`, '');
                recordNameInput.value = apiName;
                recordTtlSelect.value = record.ttl; // TTL is stored directly
                proxyStatusCheckbox.checked = record.proxied;

                // Set the correct content field based on type
                updateRecordFormUI(record.type); // Show/hide correct fields first
                 const contentInputId = `#record-content-${record.type}`;
                 let contentInput = document.querySelector(contentInputId);
                 if (!contentInput) { // Fallback for types without specific fields
                     contentInput = document.getElementById('record-content-generic');
                 }
                 if (contentInput) {
                     if (record.type === 'TXT' && contentInput.tagName === 'TEXTAREA') {
                          contentInput.value = record.content; // Use value for textarea
                     } else if (contentInput.tagName === 'INPUT'){
                         contentInput.value = record.content;
                     }
                 }
                  // Handle MX priority
                 if (record.type === 'MX') {
                     mxPriorityInput.value = record.priority;
                 }

                showModal(recordFormModal);
             }


            // Update visible content fields based on record type
            function updateRecordFormUI(recordType) {
                 // Hide all type-specific content fields first
                 document.querySelectorAll('[id^="content-field-"]').forEach(el => hideElement(el));
                 // Hide MX priority initially
                 hideElement(document.getElementById('content-field-MX').querySelector('[for="record-priority"]').parentElement);


                 // Show the relevant content field
                 let contentFieldId = `content-field-${recordType}`;
                 let contentField = document.getElementById(contentFieldId);
                 if (!contentField) {
                     contentField = document.getElementById('content-field-generic'); // Fallback
                 }
                  showElement(contentField);

                 // Show priority for MX
                 if (recordType === 'MX') {
                     showElement(document.getElementById('content-field-MX').querySelector('[for="record-priority"]').parentElement);
                 }

                 // Enable/disable proxy toggle
                 const canProxy = ['A', 'AAAA', 'CNAME'].includes(recordType);
                 proxyToggleContainer.style.display = canProxy ? 'flex' : 'none';
                 if (!canProxy) {
                     proxyStatusCheckbox.checked = false; // Cannot proxy other types
                 }
                 proxyStatusCheckbox.disabled = !canProxy;
            }

            recordTypeSelect.addEventListener('change', (e) => {
                 updateRecordFormUI(e.target.value);
            });

            // Handle form submission (Add or Edit)
            dnsRecordForm.addEventListener('submit', async (e) => {
                 e.preventDefault();
                 const recordId = recordIdInput.value;
                 const zoneId = currentZoneIdInput.value;
                 const isEditing = !!recordId;
                 const recordType = recordTypeSelect.value;

                 // Get content from the currently visible input
                 let content = '';
                 const activeContentFieldId = `#record-content-${recordType}`;
                 let contentInput = document.querySelector(activeContentFieldId);
                  if (!contentInput || contentInput.closest('.hidden')) { // Check if visible parent exists
                      contentInput = document.getElementById('record-content-generic');
                  }
                 if (contentInput) content = contentInput.value.trim();


                 // Construct payload common fields
                 const payload = {
                     type: recordType,
                     name: recordNameInput.value.trim(), // API handles '@' correctly, needs full name for subdomains
                     content: content,
                     ttl: parseInt(recordTtlSelect.value, 10),
                     proxied: proxyStatusCheckbox.disabled ? undefined : proxyStatusCheckbox.checked, // Only include if applicable
                 };

                 // Add type-specific fields
                 if (recordType === 'MX') {
                     payload.priority = parseInt(mxPriorityInput.value, 10);
                     if (isNaN(payload.priority)) {
                        showNotification('错误', 'MX 记录需要有效的优先级。', 'error');
                        return;
                     }
                 }
                 // Add validation for SRV, CAA etc. if implemented

                 // Basic validation
                 if (!payload.name || !payload.content) {
                     showNotification('错误', '记录名称和内容不能为空。', 'error');
                     return;
                 }

                 const submitButton = dnsRecordForm.querySelector('button[type="submit"]');
                 submitButton.disabled = true;
                 submitButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>${isEditing ? '更新中' : '添加中'}...`;

                 try {
                     let response;
                     if (isEditing) {
                         // Update requires PATCH or PUT
                         response = await cloudflareApiRequest(`/zones/${zoneId}/dns_records/${recordId}`, 'PUT', payload); // Using PUT to replace fully
                         showNotification('成功', `DNS 记录 "${response.result.name}" 已更新。`, 'success');
                     } else {
                         response = await cloudflareApiRequest(`/zones/${zoneId}/dns_records`, 'POST', payload);
                         showNotification('成功', `DNS 记录 "${response.result.name}" 已添加。`, 'success');
                     }

                     hideModal(recordFormModal);
                     // Refresh the DNS list in the background modal
                     openDnsModal(zoneId, dnsModalDomainTitle.textContent); // Re-fetch and render

                 } catch (error) {
                     showNotification('保存失败', `保存 DNS 记录时出错: ${error.message}`, 'error', 0);
                 } finally {
                     submitButton.disabled = false;
                     submitButton.innerHTML = '保存记录';
                 }
            });


            // --- Confirmation Modal Logic ---
            cancelConfirmButton.addEventListener('click', () => {
                 hideModal(confirmModal);
                 currentConfirmCallback = null;
            });

            proceedConfirmButton.addEventListener('click', () => {
                 if (typeof currentConfirmCallback === 'function') {
                     currentConfirmCallback(); // Execute the stored action
                     // Callback should handle hiding modal on success/failure as needed
                 }
                 currentConfirmCallback = null; // Reset callback
             });

             // --- Notification Logic ---
            closeNotificationButton.addEventListener('click', hideNotification);

            // --- Helper: Get Type Color ---
             function getRecordTypeClass(type) {
                 const typeClasses = {
                     'A': 'bg-blue-100 text-blue-800', 'AAAA': 'bg-sky-100 text-sky-800',
                     'CNAME': 'bg-purple-100 text-purple-800', 'MX': 'bg-pink-100 text-pink-800',
                     'TXT': 'bg-gray-100 text-gray-800', 'NS': 'bg-indigo-100 text-indigo-800',
                     'SRV': 'bg-teal-100 text-teal-800', 'CAA': 'bg-red-100 text-red-800',
                     'PTR': 'bg-orange-100 text-orange-800', 'SPF': 'bg-lime-100 text-lime-800',
                     'CERT': 'bg-cyan-100 text-cyan-800', 'DNSKEY': 'bg-fuchsia-100 text-fuchsia-800',
                     'DS': 'bg-rose-100 text-rose-800', 'NAPTR': 'bg-violet-100 text-violet-800',
                     'SMIMEA': 'bg-emerald-100 text-emerald-800', 'SSHFP': 'bg-amber-100 text-amber-800',
                     'TLSA': 'bg-yellow-100 text-yellow-800', 'URI': 'bg-green-100 text-green-800'
                 };
                 return typeClasses[type] || 'bg-gray-100 text-gray-800';
             }


            // --- Init ---
            loadAndValidateCredentials(); // Check session storage and validate on load

        });
    </script>
</body>
</html>
